<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂位管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- 1. 登入畫面 -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center bg-gray-800">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">後台管理登入</h2>
            <input type="password" id="adminPassword" placeholder="請輸入管理員密碼" 
                   class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-orange-500">
            <button onclick="checkLogin()" class="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700 transition">
                登入
            </button>
            <p class="text-xs text-gray-400 mt-4 text-center">預設密碼：admin123</p>
        </div>
    </div>

    <!-- 2. 管理儀表板 -->
    <div id="dashboardSection" class="hidden min-h-screen">
        <!-- Header -->
        <nav class="bg-white shadow mb-8">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center text-orange-600 font-bold text-xl">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> 訂位管理系統
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-red-500 text-sm">
                    <i class="fa-solid fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </nav>

        <!-- Content -->
        <div class="max-w-7xl mx-auto px-4">
            
            <!-- 狀態與工具列 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow border-l-4 border-orange-500">
                    <p class="text-gray-500 text-sm">總訂位數</p>
                    <p class="text-3xl font-bold text-gray-800" id="totalCount">0</p>
                </div>
            </div>

            <!-- 按鈕區 -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-700">預約列表</h3>
                <div>
                    <!-- 新增：匯出 CSV 按鈕 -->
                    <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition mr-2 shadow">
                        <i class="fa-solid fa-file-csv mr-1"></i> 匯出 CSV
                    </button>
                    
                    <button onclick="loadReservations()" class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded hover:bg-gray-50 transition shadow">
                        <i class="fa-solid fa-rotate-right mr-1"></i> 重新整理
                    </button>
                </div>
            </div>

            <!-- 表格 -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">日期/時間</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">姓名/電話</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">人數</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">備註</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="reservationTableBody">
                            <tr><td colspan="5" class="px-5 py-10 text-center text-gray-500">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // TODO: 請在此處貼上您的 Firebase Config (跟 index.html 一樣)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAYgc49iXduqsebhzgORrQlUZ-goW4U3kk",
            authDomain: "ginger-duck-booking.firebaseapp.com",
            projectId: "ginger-duck-booking",
            storageBucket: "ginger-duck-booking.firebasestorage.app",
            messagingSenderId: "944895605206",
            appId: "1:944895605206:web:f2e006b9dcd0749a478c77",
            measurementId: "G-72Z5CRG1RF"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase 初始化失敗");
        }

        // --- 登入邏輯 ---
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');

        window.checkLogin = function() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd === "admin123") {
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                loadReservations(); 
            } else {
                alert("密碼錯誤！");
            }
        }

        window.logout = function() {
            location.reload();
        }

        // --- 資料載入 ---
        window.loadReservations = async function() {
            if (!db) return;
            const tbody = document.getElementById('reservationTableBody');
            const totalCountEl = document.getElementById('totalCount');
            
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="animate-spin inline-block w-6 h-6 border-2 border-orange-500 rounded-full border-t-transparent"></div> 載入中...</td></tr>`;

            try {
                const q = query(collection(db, "reservations"), orderBy("date", "asc")); 
                const querySnapshot = await getDocs(q);

                let html = "";
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    count++;
                    html += `
                        <tr class="hover:bg-gray-50 border-b border-gray-200">
                            <td class="px-5 py-5 bg-white text-sm">
                                <div><p class="font-bold text-gray-900">${data.date}</p><p class="text-gray-500">${data.time}</p></div>
                            </td>
                            <td class="px-5 py-5 bg-white text-sm">
                                <div><p class="text-gray-900">${data.name}</p><p class="text-gray-500">${data.phone}</p></div>
                            </td>
                            <td class="px-5 py-5 bg-white text-sm">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-semibold">${data.guests} 位</span>
                            </td>
                            <td class="px-5 py-5 bg-white text-sm text-gray-600">${data.note || '-'}</td>
                            <td class="px-5 py-5 bg-white text-sm">
                                <button onclick="deleteReservation('${doc.id}')" class="text-red-600 hover:text-red-900 font-bold text-xs border border-red-200 px-2 py-1 rounded">刪除</button>
                            </td>
                        </tr>
                    `;
                });

                if (count === 0) html = `<tr><td colspan="5" class="text-center py-8 text-gray-500">尚無資料</td></tr>`;
                
                tbody.innerHTML = html;
                totalCountEl.innerText = count;

            } catch (error) {
                console.error("Error:", error);
                if (error.message.includes("index")) {
                     alert("請按 F12 打開 Console 建立 Firebase 索引。");
                } else {
                     tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">載入失敗</td></tr>`;
                }
            }
        }

        // --- 刪除功能 ---
        window.deleteReservation = async function(docId) {
            if (!confirm("確定要刪除此訂單嗎？")) return;
            try {
                await deleteDoc(doc(db, "reservations", docId));
                loadReservations();
            } catch (error) {
                alert("刪除失敗");
            }
        }

        // --- CSV 匯出功能 (新功能) ---
        window.exportCSV = async function() {
            if (!db) return;
            
            // 1. 重新抓取最新資料以確保匯出的是最新的
            const q = query(collection(db, "reservations"), orderBy("date", "asc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                alert("目前沒有資料可以匯出！");
                return;
            }

            // 2. 準備 CSV 內容
            // \uFEFF 是 BOM (Byte Order Mark)，讓 Excel 知道這是 UTF-8 編碼，才不會顯示亂碼
            let csvContent = "\uFEFF"; 
            
            // 標題列
            csvContent += "日期,時間,姓名,電話,人數,備註\n";

            querySnapshot.forEach((doc) => {
                const d = doc.data();
                // 為了避免內容中有逗號導致欄位錯亂，我們把每個欄位都用雙引號包起來
                // 如果備註裡有雙引號，要換成兩個雙引號 (Excel 規則)
                const safeNote = (d.note || "").replace(/"/g, '""');
                
                const row = [
                    `"${d.date}"`,
                    `"${d.time}"`,
                    `"${d.name}"`,
                    `"${d.phone}"`,
                    `"${d.guests}"`,
                    `"${safeNote}"`
                ];
                
                csvContent += row.join(",") + "\n";
            });

            // 3. 觸發下載
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            
            // 設定檔名：訂位資料_2023-12-08.csv
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("href", url);
            link.setAttribute("download", `訂位資料_${today}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
