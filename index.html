<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南投薑母鴨價格分析與線上訂位</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FFF7ED;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 300px;
            }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(251, 146, 60, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #ea580c;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Chosen Palette: Warm Spicy Palette -->
    <!-- Application Structure Update:
        Added a new Section 5: "Reservation" at the bottom.
        This section includes a form connected to Firebase Firestore via pure JS (Modular SDK).
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="text-slate-800">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-white shadow-md border-b border-orange-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-bowl-food text-orange-600 text-2xl mr-2"></i>
                    <span class="font-bold text-xl text-orange-800">薑母鴨情報與訂位</span>
                </div>
                <div class="hidden md:flex space-x-6 items-center">
                    <button onclick="scrollToSection('verdict')" class="hover:text-orange-600 font-medium transition">價格診斷</button>
                    <button onclick="scrollToSection('national')" class="hover:text-orange-600 font-medium transition">全台比價</button>
                    <button onclick="scrollToSection('analysis')" class="hover:text-orange-600 font-medium transition">成本分析</button>
                    <button onclick="scrollToSection('calculator')" class="hover:text-orange-600 font-medium transition">試算</button>
                    <!-- Reservation Button Highlight -->
                    <button onclick="scrollToSection('reservation')" class="bg-orange-600 text-white px-4 py-2 rounded-full hover:bg-orange-700 transition shadow-lg flex items-center">
                        <i class="fa-solid fa-calendar-check mr-2"></i> 線上訂位
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- SECTION 1: Verdict -->
        <section id="verdict" class="space-y-6">
            <div class="text-center space-y-4">
                <h1 class="text-3xl md:text-5xl font-bold text-orange-900 leading-tight">
                    南投一份 <span class="text-red-600">500元</span> 算正常嗎？
                </h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    市場數據分析與線上預約系統。
                </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card rounded-2xl p-6 border-t-4 border-red-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">價格診斷</h3>
                        <i class="fa-solid fa-gavel text-red-500 text-2xl"></i>
                    </div>
                    <div class="text-4xl font-bold text-red-600 mb-2">偏高</div>
                    <p class="text-gray-600">高於市場均價約 30%，但若含紅面番鴨與全酒則屬合理。</p>
                </div>
                <div class="glass-card rounded-2xl p-6 border-t-4 border-yellow-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">關鍵因素</h3>
                        <i class="fa-solid fa-magnifying-glass-chart text-yellow-500 text-2xl"></i>
                    </div>
                    <ul class="space-y-2 text-gray-600 text-sm">
                        <li><i class="fa-solid fa-check text-yellow-500 mr-2"></i>紅面番鴨公 (成本+40%)</li>
                        <li><i class="fa-solid fa-check text-yellow-500 mr-2"></i>全酒料理 (不加水)</li>
                        <li><i class="fa-solid fa-check text-yellow-500 mr-2"></i>炭火陶鍋 (人力成本)</li>
                    </ul>
                </div>
                <div class="glass-card rounded-2xl p-6 border-t-4 border-green-500">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">建議</h3>
                        <i class="fa-solid fa-chart-line text-green-500 text-2xl"></i>
                    </div>
                    <p class="text-gray-600">若人數超過 3 人，選擇 500 元大鍋底並加點平價配菜，CP 值反而高於連鎖小火鍋。</p>
                </div>
            </div>
        </section>

        <!-- SECTION 2: National Comparison -->
        <section id="national" class="bg-white rounded-3xl p-8 shadow-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-orange-500 pl-4">全台行情比較</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="chart-container">
                        <canvas id="nationalPriceChart"></canvas>
                    </div>
                </div>
                <div class="flex flex-col justify-center space-y-4 text-sm text-gray-600">
                    <p><strong>北部 (雙北):</strong> 均價 450-480 元，店租成本高。</p>
                    <p><strong>中部 (南投/台中):</strong> 均價 350-400 元。500元屬於特色名店價格。</p>
                    <p><strong>南部:</strong> 均價 350 元，通常配料較優惠。</p>
                </div>
            </div>
        </section>

        <!-- SECTION 3: Cost Analysis -->
        <section id="analysis" class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 text-center">500元的成本結構</h2>
            <div class="bg-white p-6 rounded-3xl shadow-sm flex flex-col items-center justify-center">
                <div class="chart-container" style="height: 300px; max-width: 300px;">
                    <canvas id="costBreakdownChart"></canvas>
                </div>
                <p class="text-xs text-gray-400 mt-4">食材成本佔比最高 (鴨肉/老薑/麻油)</p>
            </div>
        </section>

        <!-- SECTION 4: Calculator -->
        <section id="calculator" class="bg-orange-600 rounded-3xl p-8 text-white shadow-xl">
            <h2 class="text-3xl font-bold mb-6">價格試算器</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-orange-200 mb-1">鍋底</label>
                        <select id="potType" class="w-full p-2 rounded text-gray-800"><option value="380">標準 (380)</option><option value="500">頂級 (500)</option></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-orange-200">蔬菜/配料盤數</label><input type="number" id="vegCount" value="4" class="w-full p-2 rounded text-gray-800"></div>
                        <div><label class="block text-sm text-orange-200">飲料/酒水瓶數</label><input type="number" id="drinkCount" value="2" class="w-full p-2 rounded text-gray-800"></div>
                    </div>
                </div>
                <div class="flex flex-col justify-center items-center bg-white bg-opacity-10 rounded-xl p-4">
                    <span class="text-sm text-orange-200">預估總價</span>
                    <span class="text-5xl font-bold my-2" id="totalPrice">--</span>
                    <span class="text-xs text-orange-200" id="avgPrice"></span>
                </div>
            </div>
        </section>

        <!-- NEW SECTION 5: Firebase Reservation -->
        <section id="reservation" class="scroll-mt-24">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-0 shadow-2xl rounded-3xl overflow-hidden">
                <!-- Left: Info -->
                <div class="bg-gray-900 p-10 text-white flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-orange-600 rounded-full opacity-20 blur-3xl"></div>
                    <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-red-600 rounded-full opacity-20 blur-3xl"></div>
                    
                    <h2 class="text-3xl font-bold mb-6">想親自品嚐？<br><span class="text-orange-500">立即線上訂位</span></h2>
                    <p class="text-gray-400 mb-8 leading-relaxed">
                        我們使用即時雲端系統，您的訂位將直接傳送至餐廳後台。請填寫下方資訊，我們將保留您的席位 10 分鐘。
                    </p>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-orange-900 flex items-center justify-center mr-4 text-orange-500"><i class="fa-solid fa-phone"></i></div>
                            <div>
                                <p class="text-xs text-gray-500">訂位專線</p>
                                <p class="font-bold">049-2xxx-xxxx</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-orange-900 flex items-center justify-center mr-4 text-orange-500"><i class="fa-solid fa-location-dot"></i></div>
                            <div>
                                <p class="text-xs text-gray-500">餐廳地址</p>
                                <p class="font-bold">南投縣南投市...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Form -->
                <div class="bg-white p-10 relative">
                    <div id="bookingSuccess" class="hidden absolute inset-0 bg-white z-10 flex flex-col items-center justify-center text-center p-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fa-solid fa-check text-4xl text-green-600"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">預約成功！</h3>
                        <p class="text-gray-600 mb-6">我們已收到您的訂位資訊，<br>期待您的光臨。</p>
                        <button onclick="resetForm()" class="text-orange-600 font-bold hover:underline">再預約一筆</button>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-6">填寫訂位資訊</h3>
                    <form id="bookingForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">日期</label>
                                <input type="date" id="rDate" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">時間</label>
                                <input type="time" id="rTime" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">姓名</label>
                            <input type="text" id="rName" placeholder="王大明" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">電話</label>
                                <input type="tel" id="rPhone" placeholder="0912-345678" required class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">人數</label>
                                <select id="rGuests" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition">
                                    <option value="2">2 位</option>
                                    <option value="3">3 位</option>
                                    <option value="4" selected>4 位</option>
                                    <option value="5">5 位</option>
                                    <option value="6">6 位</option>
                                    <option value="7">7 位以上</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">備註 (選填)</label>
                            <textarea id="rNote" rows="2" placeholder="例如：需要兒童椅、不吃香菜..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:border-orange-500 transition"></textarea>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white font-bold py-4 rounded-lg hover:bg-orange-700 transition transform hover:-translate-y-1 flex justify-center items-center">
                            <span id="btnText">確認訂位</span>
                            <div id="btnLoader" class="loader hidden ml-2"></div>
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-400 text-sm py-8 border-t border-orange-100">
            <p>本系統示範如何在 GitHub Pages 上使用 Firebase 資料庫。</p>
        </footer>

    </main>

    <script type="module">
        // -----------------------------------------------------------
        // 1. FIREBASE SETUP (MODULAR SDK)
        // -----------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // TODO: 請在此處替換成您自己的 Firebase 設定
        // 1. 去 firebase.google.com 建立專案
        // 2. 新增 Web App 取得設定
        // 3. 在 Firestore Database 規則中設定 "allow read, write: if true;" (測試用)
        // =================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        // 注意：為了避免未填寫設定導致報錯，這裡加了 try-catch
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.warn("Firebase尚未設定，請在程式碼中填入您的 Config");
        }

        // -----------------------------------------------------------
        // 2. RESERVATION LOGIC
        // -----------------------------------------------------------
        const bookingForm = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const bookingSuccess = document.getElementById('bookingSuccess');

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 檢查 Firebase 是否初始化
            if (!db) {
                alert("系統錯誤：Firebase 尚未設定。請聯絡網站管理員。");
                return;
            }

            // UI Loading State
            submitBtn.disabled = true;
            btnText.innerText = "處理中...";
            btnLoader.classList.remove('hidden');

            // Collect Data
            const formData = {
                name: document.getElementById('rName').value,
                phone: document.getElementById('rPhone').value,
                date: document.getElementById('rDate').value,
                time: document.getElementById('rTime').value,
                guests: document.getElementById('rGuests').value,
                note: document.getElementById('rNote').value,
                createdAt: serverTimestamp() // 使用伺服器時間
            };

            try {
                // 寫入資料庫 'reservations' 集合
                const docRef = await addDoc(collection(db, "reservations"), formData);
                console.log("Document written with ID: ", docRef.id);
                
                // Show Success Message
                bookingSuccess.classList.remove('hidden');
                
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("訂位失敗，請稍後再試。\n錯誤訊息: " + error.message);
            } finally {
                // Reset UI
                submitBtn.disabled = false;
                btnText.innerText = "確認訂位";
                btnLoader.classList.add('hidden');
            }
        });

        // Expose reset function to window for the "再預約一筆" button
        window.resetForm = function() {
            bookingForm.reset();
            bookingSuccess.classList.add('hidden');
        };

        // -----------------------------------------------------------
        // 3. EXISTING CHART & APP LOGIC
        // -----------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            initNationalChart();
            initCostChart();
            updateCalc();
            
            // Set default date to today
            const dateInput = document.getElementById('rDate');
            if(dateInput) dateInput.valueAsDate = new Date();
        });

        // Navigation
        window.scrollToSection = function(id) {
            const el = document.getElementById(id);
            if (el) {
                window.scrollTo({
                    top: el.offsetTop - 80,
                    behavior: 'smooth'
                });
            }
        };

        // Charts Logic
        function initNationalChart() {
            const ctx = document.getElementById('nationalPriceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['雲嘉', '台南', '台中', '南投(均)', '台北', '南投(此店)'],
                    datasets: [{
                        label: '價格',
                        data: [320, 360, 380, 380, 450, 500],
                        backgroundColor: ['#e5e7eb','#e5e7eb','#e5e7eb','#fb923c','#e5e7eb','#dc2626'],
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
        }

        function initCostChart() {
            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['食材', '人力', '租金', '利潤'],
                    datasets: [{
                        data: [45, 25, 15, 15],
                        backgroundColor: ['#ea580c', '#fdba74', '#94a3b8', '#cbd5e1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%' }
            });
        }

        // Calculator Logic
        const inputs = ['potType', 'vegCount', 'drinkCount'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('change', updateCalc);
            document.getElementById(id).addEventListener('input', updateCalc);
        });

        function updateCalc() {
            const pot = parseInt(document.getElementById('potType').value);
            const veg = parseInt(document.getElementById('vegCount').value) * 50;
            const drink = parseInt(document.getElementById('drinkCount').value) * 100;
            const total = pot + veg + drink;
            document.getElementById('totalPrice').innerText = total;
            document.getElementById('avgPrice').innerText = `(若4人用餐，每人約 ${Math.round(total/4)} 元)`;
        }
    </script>
</body>
</html>
