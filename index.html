<script type="module">
        // -----------------------------------------------------------
        // 1. FIREBASE SETUP (修正 Import)
        // -----------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // 注意：這裡補上了 query, where, serverTimestamp
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // CONFIG
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAYgc49iXduqsebhzgORrQlUZ-goW4U3kk",
            authDomain: "ginger-duck-booking.firebaseapp.com",
            projectId: "ginger-duck-booking",
            storageBucket: "ginger-duck-booking.firebasestorage.app",
            messagingSenderId: "944895605206",
            appId: "1:944895605206:web:f2e006b9dcd0749a478c77",
            measurementId: "G-72Z5CRG1RF"
        };

        // 初始化變數 (修正重複宣告與 Scope 問題)
        let app, auth, db;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase 初始化成功");
        } catch (e) {
            console.error("Firebase 初始化失敗:", e);
            Swal.fire('系統錯誤', '無法連接資料庫，請檢查網路或設定', 'error');
        }

        // -----------------------------------------------------------
        // 2. AUTHENTICATION (匿名登入)
        // -----------------------------------------------------------
        signInAnonymously(auth)
            .then(() => {
                console.log("✅ 匿名登入成功！");
                // 這裡我不更動 DOM，因為您的 HTML 裡好像移除了 id="status" 的元素，避免報錯
            })
            .catch((error) => {
                console.error("❌ 登入失敗：", error.code, error.message);
                Swal.fire('連線錯誤', '無法進行匿名登入', 'error');
            });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("目前使用者 ID (UID):", user.uid);
            } else {
                console.log("使用者已登出");
            }
        });

        // -----------------------------------------------------------
        // 3. LOGIC: Booking & Checking
        // -----------------------------------------------------------
        
        // Tab Switching
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-orange-600'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.getElementById('content-book').classList.add('hidden');
            document.getElementById('content-check').classList.add('hidden');
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        // Submit Booking
        const bookingForm = document.getElementById('bookingForm');
        if(bookingForm){
            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) return Swal.fire('錯誤', 'Firebase 尚未設定', 'error');

                const btn = document.getElementById('submitBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 處理中...';
                btn.disabled = true;

                try {
                    const formData = {
                        date: document.getElementById('rDate').value,
                        time: document.getElementById('rTime').value,
                        name: document.getElementById('rName').value,
                        phone: document.getElementById('rPhone').value,
                        guests: document.getElementById('rGuests').value,
                        note: document.getElementById('rNote').value,
                        status: 'pending', 
                        createdAt: serverTimestamp() // 這裡現在可以正常運作了
                    };

                    await addDoc(collection(db, "reservations"), formData);
                    
                    Swal.fire({
                        icon: 'success',
                        title: '訂位成功！',
                        text: '我們已收到您的預約，期待您的光臨。',
                        confirmButtonColor: '#ea580c'
                    });
                    
                    document.getElementById('bookingForm').reset();
                    // 重設日期為今天
                    document.getElementById('rDate').valueAsDate = new Date();

                } catch (error) {
                    console.error("寫入錯誤:", error);
                    Swal.fire('錯誤', '訂位失敗：' + error.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        // Check Reservation
        window.checkReservation = async function() {
            if (!db) return Swal.fire('錯誤', 'Firebase 尚未設定', 'error');
            
            const phone = document.getElementById('checkPhone').value;
            if (!phone) return Swal.fire('提示', '請輸入手機號碼', 'warning');

            const resultDiv = document.getElementById('checkResult');
            resultDiv.innerHTML = '<div class="text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin"></i> 查詢中...</div>';

            try {
                // Query by phone number
                // 注意：這裡需要 Firestore Index，如果查詢失敗看 Console
                const q = query(collection(db, "reservations"), where("phone", "==", phone));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    resultDiv.innerHTML = `
                        <div class="bg-gray-50 p-4 rounded-xl text-center border border-gray-200">
                            <i class="fa-regular fa-face-frown text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">找不到此號碼 (${phone}) 的訂位紀錄。</p>
                        </div>`;
                } else {
                    let html = '';
                    querySnapshot.forEach((doc) => {
                        const d = doc.data();
                        const statusColor = d.status === 'seated' ? 'text-green-600 bg-green-50' : 'text-yellow-600 bg-yellow-50';
                        const statusText = d.status === 'seated' ? '已報到' : '已確認 (未報到)';
                        
                        html += `
                            <div class="bg-white border border-gray-100 shadow-sm rounded-xl p-4 mb-3 flex justify-between items-center relative overflow-hidden">
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-orange-500"></div>
                                <div>
                                    <p class="font-bold text-gray-800">${d.date} ${d.time}</p>
                                    <p class="text-sm text-gray-500">${d.name} / ${d.guests} 位</p>
                                </div>
                                <span class="text-xs font-bold px-3 py-1 rounded-full ${statusColor}">${statusText}</span>
                            </div>
                        `;
                    });
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                console.error("查詢錯誤:", error);
                if(error.message.includes("index")) {
                     // 這是最常見的查詢錯誤，需要去 Firebase Console 建立索引
                     const link = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                     if(link) {
                         console.log("請點擊此連結建立索引:", link[0]);
                         Swal.fire('系統提示', '這是第一次執行此查詢，請開發者查看 Console 並點擊連結建立索引。', 'info');
                     } else {
                         Swal.fire('系統提示', '需要建立 Firebase Index 才能使用查詢功能', 'info');
                     }
                } else {
                    resultDiv.innerHTML = '<p class="text-red-500 text-center">查詢發生錯誤</p>';
                }
            }
        };

        // -----------------------------------------------------------
        // 4. UI INITIALIZATION & CHARTS
        // -----------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            initCalculator();
            
            const dateInput = document.getElementById('rDate');
            if(dateInput) dateInput.valueAsDate = new Date();
        });

        function initCharts() {
            const ctx1 = document.getElementById('nationalPriceChart');
            if (ctx1) {
                new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['雲嘉(平價)', '台中(均價)', '台北(高價)', '本南投名店'],
                        datasets: [{
                            label: '鍋底價格',
                            data: [320, 380, 450, 500],
                            backgroundColor: ['#e5e7eb','#e5e7eb','#e5e7eb','#ea580c'],
                            borderRadius: 6
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: {display:false} },
                        scales: { y: { beginAtZero: false, min: 200 } }
                    }
                });
            }

            const ctx2 = document.getElementById('costBreakdownChart');
            if (ctx2) {
                new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['紅面鴨/老薑', '純米酒', '人力與炭火', '利潤'],
                        datasets: [{
                            data: [40, 20, 25, 15],
                            backgroundColor: ['#c2410c', '#ea580c', '#fb923c', '#fed7aa'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
                });
            }
        }

        function initCalculator() {
            const inputs = ['potType', 'vegCount', 'peopleCount'];
            const update = () => {
                const pot = parseInt(document.getElementById('potType').value) || 0;
                const veg = (parseInt(document.getElementById('vegCount').value) || 0) * 50; 
                const people = parseInt(document.getElementById('peopleCount').value) || 1;
                
                const total = pot + veg;
                const avg = Math.round(total / people);

                document.getElementById('totalPrice').innerText = total;
                document.getElementById('avgPrice').innerText = avg;
            };
            
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el){
                    el.addEventListener('change', update);
                    el.addEventListener('input', update);
                }
            });
            update(); 
        }
    </script>
